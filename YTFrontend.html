<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LibreWatch</title>
<style>
body{font-family:sans-serif;background:#111;color:#eee;display:flex;flex-direction:column;align-items:center;padding:2rem}
#player{width:640px;max-width:95vw;height:360px;margin-top:1rem}
input,button{padding:.5rem;margin:.25rem;font-size:1rem}
</style>
</head>
<body>

<h1>LibreWatch</h1>

<div>
  <input id="videoInput" value="dQw4w9WgXcQ">
  <button id="loadBtn">Load</button>
</div>

<div id="player"></div>

<script>
const sponsorAPI="https://sponsor.ajay.app/";
let player=null;
let sponsorSegments=[];

const tag=document.createElement("script");
tag.src="https://www.youtube.com/iframe_api";
document.head.appendChild(tag);

window.onYouTubeIframeAPIReady=()=>{}; // YouTube API ready

function extractVideoID(input){
  try{
    if(input.includes("youtube.com")||input.includes("youtu.be")){
      const url=new URL(input);
      return url.searchParams.get("v")||url.pathname.split("/").pop();
    }
    return input.trim();
  }catch{return input.trim();}
}

async function getSponsorSegments(videoId){
  try{
    const res=await fetch(`${sponsorAPI}api/skipSegments?videoID=${videoId}`);
    if(!res.ok)return[];
    const data=await res.json();
    return data.sort((a,b)=>a.segment[0]-b.segment[0]);
  }catch{return[];}
}

function createPlayer(videoId){
  document.getElementById("player").innerHTML="<div id='yt'></div>";

  player=new YT.Player("yt",{
    videoId:videoId,
    playerVars:{autoplay:1,mute:1,rel:0,modestbranding:1,enablejsapi:1,origin:window.location.origin},
    events:{onReady:(e)=>{e.target.unMute();startSponsorWatcher();}}
  });
}

function startSponsorWatcher(){
  setInterval(()=>{
    if(!player||!player.getCurrentTime)return;
    const current=player.getCurrentTime();
    for(const seg of sponsorSegments){
      const[start,end]=seg.segment;
      if(current>=start&&current<end){
        player.seekTo(end,true); break;
      }
    }
  },300);
}

async function loadVideo(){
  const id=extractVideoID(document.getElementById("videoInput").value);
  if(!id)return alert("Invalid ID");

  sponsorSegments=await getSponsorSegments(id);
  if(player)player.destroy();
  createPlayer(id);
}

document.getElementById("loadBtn").addEventListener("click",loadVideo);
</script>

</body>
</html>

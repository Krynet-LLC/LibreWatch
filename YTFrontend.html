<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Krynet, LLC | Watch Together</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#121212; color:#eee; font-family: Arial, sans-serif; padding: 1rem; }
#resultsContainer { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 1rem; margin-top: 1rem; }
.video { cursor: pointer; background: #222; border-radius: 8px; overflow:hidden; transition: transform 0.2s; }
.video:hover { transform: scale(1.02); }
.video img { width: 100%; display: block; }
.info { padding: 0.5rem; }
input, button { font-size: 1rem; padding: .5rem 1rem; border-radius: 9999px; border: none; }
input { width: 60%; background:#222; color:#eee; }
button { background:#bb86fc; color:#121212; font-weight:bold; cursor:pointer; }
#playerContainer { margin-top: 1rem; position:relative; }
iframe { width:100%; height:360px; border:none; border-radius:12px; }
</style>
</head>
<body>

<input type="text" id="searchInput" placeholder="Search YouTube...">
<button id="searchButton">Search</button>

<div id="playerContainer"></div>
<div id="resultsContainer"></div>

<script type="module">
import { config } from './config.js';

const searchInput = document.getElementById('searchInput');
const searchButton = document.getElementById('searchButton');
const resultsContainer = document.getElementById('resultsContainer');
const playerContainer = document.getElementById('playerContainer');

let sponsorSegments = [];
let skipInterval;
let currentVideoId = null;

// ------------------ SponsorBlock ------------------
async function fetchSponsorSegments(videoId) {
    try {
        const res = await fetch(`${config.sponsorBlock}/api/skipSegments?videoID=${videoId}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const segments = await res.json();
        sponsorSegments = segments.sort((a,b)=>a.segment[0]-b.segment[0]);
    } catch(err) {
        console.warn('SponsorBlock fetch failed:', err);
        sponsorSegments = [];
    }
}

function startAutoSkip() {
    if(skipInterval) clearInterval(skipInterval);
    const iframe = document.querySelector('#playerContainer iframe');
    if(!iframe) return;

    skipInterval = setInterval(() => {
        if(!iframe || !sponsorSegments.length) return;
        const t = iframe.contentWindow?.document?.querySelector('video')?.currentTime;
        if(t === undefined) return;
        for(const seg of sponsorSegments) {
            const [start, end] = seg.segment;
            if(t >= start && t < end) {
                iframe.contentWindow.document.querySelector('video').currentTime = end + 0.01;
                break;
            }
        }
    }, 200);
}

// ------------------ Play Video ------------------
async function playVideo(video) {
    currentVideoId = video.id;
    await fetchSponsorSegments(video.id);

    playerContainer.innerHTML = '';
    const iframe = document.createElement('iframe');
    iframe.src = `${config.UI}watch?v=${video.id}&autoplay=1`;
    iframe.allow = 'autoplay; fullscreen';
    iframe.frameBorder = '0';
    iframe.loading = 'lazy';
    iframe.style.borderRadius = '12px';
    iframe.style.width = '100%';
    iframe.style.height = '360px';
    playerContainer.appendChild(iframe);

    startAutoSkip();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ------------------ Search ------------------
async function searchVideos(query) {
    try {
        const url = config.Proxy + config.API + `search?q=${encodeURIComponent(query)}&type=videos`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        return data.items || data || [];
    } catch(err) {
        console.error('Search failed:', err);
        resultsContainer.innerHTML = `<p>Error fetching videos: ${err.message}</p>`;
        return [];
    }
}

// ------------------ Render ------------------
function renderResults(videos) {
    resultsContainer.innerHTML = '';
    if(!videos.length) {
        resultsContainer.innerHTML = '<p>No results found.</p>';
        return;
    }

    videos.forEach(video => {
        const thumb = video.thumbnailUrl || video.thumbnails?.[0]?.url || '';
        const div = document.createElement('div');
        div.className = 'video';
        div.innerHTML = `<img src="${thumb}" alt="${video.title}"><div class="info"><h3>${video.title}</h3></div>`;
        div.onclick = () => playVideo(video);
        resultsContainer.appendChild(div);
    });
}

// ------------------ Event ------------------
searchButton.onclick = async () => {
    const q = searchInput.value.trim();
    if(!q) return;
    resultsContainer.innerHTML = '<p>Loadingâ€¦</p>';
    const videos = await searchVideos(q);
    renderResults(videos);
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Krynet, LLC | Watch Together</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#121212; color:#eee; font-family: Arial, sans-serif; padding: 1rem; }
#resultsContainer { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 1rem; margin-top: 1rem; }
.video { cursor: pointer; background: #222; border-radius: 8px; overflow:hidden; transition: transform 0.2s; }
.video:hover { transform: scale(1.02); }
.video img { width: 100%; display: block; }
.info { padding: 0.5rem; }
input, button { font-size: 1rem; padding: .5rem 1rem; border-radius: 9999px; border: none; }
input { width: 60%; background:#222; color:#eee; }
button { background:#bb86fc; color:#121212; font-weight:bold; cursor:pointer; }
#playerContainer { margin-top: 1rem; position:relative; }
#html5Player { width:100%; height:360px; border-radius:12px; background:#000; }
</style>
</head>
<body>

<input type="text" id="searchInput" placeholder="Search YouTube...">
<button id="searchButton">Search</button>

<div id="playerContainer">
  <video id="html5Player" controls autoplay></video>
</div>
<div id="resultsContainer"></div>

<script type="module">
import { config } from './config.js';

const searchInput = document.getElementById('searchInput');
const searchButton = document.getElementById('searchButton');
const resultsContainer = document.getElementById('resultsContainer');
const html5Player = document.getElementById('html5Player');

let sponsorSegments = [];
let skipInterval;
let syncSocket;

// -------------------- SPONSORBLOCK --------------------
async function fetchSponsorSegments(videoId) {
  try {
    const res = await fetch(`${config.sponsorBlock}/api/skipSegments?videoID=${videoId}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const segments = await res.json();
    sponsorSegments = segments.sort((a,b)=>a.segment[0]-b.segment[0]);
  } catch (err) {
    console.warn('SponsorBlock fetch failed:', err);
    sponsorSegments = [];
  }
}

// -------------------- AUTO-SKIP --------------------
function startAutoSkip() {
  if (skipInterval) clearInterval(skipInterval);
  skipInterval = setInterval(() => {
    if (!html5Player || !sponsorSegments.length) return;
    const t = html5Player.currentTime;
    for (let seg of sponsorSegments) {
      const [start, end] = seg.segment;
      if (t >= start && t < end) {
        html5Player.currentTime = end + 0.01;
        break;
      }
    }
  }, 200);
}

// -------------------- VIDEO PLAYER --------------------
async function playVideo(video) {
  const vid = video.id;
  await fetchSponsorSegments(vid);
  html5Player.src = `${config.videoAPI}watch?v=${vid}`; // Piped iframe fallback
  html5Player.play();
  startAutoSkip();
  syncSend({ type: 'play', videoId: vid, time: 0 });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// -------------------- SEARCH --------------------
async function searchVideos(query) {
  try {
    const res = await fetch(`${config.pipedAPI}v1/search?q=${encodeURIComponent(query)}&type=videos`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    return data.items || data || [];
  } catch (err) {
    console.error('Search failed:', err);
    resultsContainer.innerHTML = `<p>Error fetching videos: ${err.message}</p>`;
    return [];
  }
}

function renderResults(videos) {
  resultsContainer.innerHTML = '';
  if (!videos.length) {
    resultsContainer.innerHTML = '<p>No results found.</p>';
    return;
  }

  videos.forEach(video => {
    const vid = video.id;
    const title = video.title;
    const thumb = video.thumbnailUrl || video.thumbnails?.[0]?.url;

    const div = document.createElement('div');
    div.className = 'video';
    div.innerHTML = `<img src="${thumb}" alt="${title}"><div class="info"><h3>${title}</h3></div>`;
    div.onclick = () => playVideo(video);
    resultsContainer.appendChild(div);
  });
}

searchButton.onclick = async () => {
  const q = searchInput.value.trim();
  if (!q) return;
  resultsContainer.innerHTML = '<p>Loadingâ€¦</p>';
  const videos = await searchVideos(q);
  renderResults(videos);
};

// -------------------- WATCH TOGETHER SYNC --------------------
function initSync() {
  syncSocket = new WebSocket('wss://your-sync-server.example/ws'); // replace with your server
  syncSocket.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'play' && msg.videoId !== html5Player.dataset.videoId) {
      html5Player.src = `${config.videoAPI}watch?v=${msg.videoId}`;
      html5Player.currentTime = msg.time || 0;
      html5Player.play();
    } else if (msg.type === 'seek') {
      html5Player.currentTime = msg.time;
    }
  };
}

function syncSend(data) {
  if (syncSocket && syncSocket.readyState === WebSocket.OPEN) {
    syncSocket.send(JSON.stringify(data));
  }
}

// -------------------- INIT --------------------
initSync();
</script>
</body>
</html>
